#!/usr/bin/env Rscript
# Calculate allele balance ratios (ABR) for all samples
#
# This script computes allele balance ratios (ABR) from per-sample allele depth
# (AD) and total depth (DP) tables extracted from VCF files. For each variant and
# sample, REF and ALT allele depths are used to calculate allele-specific ratios,
# retaining only alleles within a defined balance range.
#
# Inputs:
#   1) <prefix>
#        Prefix path used to name the allele depth and read depth tables (<prefix>_AD.fst and <prefix>_DP.fst) generated by bcftools extraction
#   2) Chromosome index file (tab-delimited, header required)
#        Must include: Chr_NC, Index
#
# Output:
#   - <prefix>_ABR.fst
#       Per-allele balance ratios with genomic coordinates.
#
# Usage:
#   screen -SL ratio -Logfile results/logs/allele_balance.log \
#     Rscript scripts/allele_balance_ratio.R \
#       out_data/sequencing_strains \
#       files/chrom_index_cen.txt

# Load libraries
library(fst)
library(parallel)

# Define function to calculate balance ratio
RatioStrain <- function(Strain){
  print(Strain)
  # AD
  # Convert all values separated by comma to list, and get depth.
  DfADLs <- strsplit(x = DfAD[[Strain]], split = ",")
  # DP
  DfDPLs <- DfDP[[Strain]]
  # Alleles
  DfAlleLs <- strsplit(x = DfAD[["REF_ALT"]], split = ",")

  # Calculate allele balance ratio
  DfRatioLs <- mclapply(1:length(DfADLs), mc.cores = 10, function(i){
    WkADLs <- unlist(DfADLs[i])
    WkDP <- as.numeric(DfDPLs[i])
    DfRatio <- do.call(rbind, lapply(1:length(WkADLs), function(j){
      WkAD <- as.numeric(WkADLs[j])
      WkRatio <- round(WkAD/WkDP, 4)
      # Substitute NAs by 0
      WkRatio <- ifelse(is.na(WkRatio), 0, WkRatio)
      
      # Add ratio only if it is in the desired threshold
      if (WkRatio > 0.125 & WkRatio < 0.875){
        data.frame("Strain" = Strain,
                   "Chromosome" = DfAD[["CHROM"]][i],
                   "Position" = DfAD[["POS"]][i],
                   "Index" = DfAD[["POS"]][i] + InfoDf[(InfoDf$Chr_NC == DfAD[["CHROM"]][i]),]$Index,
                   "Ref_Alt" = ifelse(j == 1, "REF", "ALT"),
                   "Allele" = unlist(DfAlleLs[[i]][j]),
                   "AD" = WkAD,
                   "DP" = WkDP,
                   "Ratio" = WkRatio)
      }
      
    }))
    
    # Add number of alleles
    DfRatio$Num <- nrow(DfRatio)
    
    # Check number of reads consistency
    if (length(DfRatio) > 0){
      DfRatio$Consistent <- ifelse(sum(DfRatio$AD) == WkDP, TRUE, FALSE)
    }
    
    DfRatio
  })
  
  # Compile data frame
  Df <- do.call(rbind, DfRatioLs)

  Df
}

# -------- Main program
system.time({
  args <- commandArgs(trailingOnly = TRUE)
  if (length(args) < 2) {
    stop("Usage: Rscript scripts/allele_balance_ratio.R <prefix> <chrom_index_file>")
  }
  Prefix <- args[1]
  FileDf <- args[2]
  FileAD <- paste0(Prefix, "_AD.fst")
  FileDP <- paste0(Prefix, "_DP.fst")
  FileOut <- paste0(Prefix, "_ABR.fst")
  
  print(paste("Rscript scripts/allele_balance_ratio.R", Prefix))
  
  # Read AD file
  print("Loading AD file")
  DfAD <- read_fst(FileAD)
  
  # Read DP file
  print("Loading DP file")
  DfDP <- read_fst(FileDP)
  
  # Read information file
  InfoDf <- read.table(FileDf, header = TRUE)
  
  # Get strains names
  Strains <- colnames(DfAD)[5:length(colnames(DfAD))]
  
  # Add a new column to combine REF and ALT information
  DfAD$REF_ALT <- paste(DfAD[["REF"]], DfAD[["ALT"]], sep = ",")
  
  # Perform analysis to all strains
  print("Analyzing strains")
  DfStrainsLs <- mclapply(Strains, mc.cores = 4, RatioStrain)
  
  print("Combining all strains in data frames one")
  # Final data frame combination
  DfStrains <- do.call(rbind, DfStrainsLs)
  
  # Save table as FST
  print("Saving files")
  write_fst(DfStrains, FileOut)
})
